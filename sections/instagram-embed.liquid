{% comment %}
  Shopify Section: Instagram Grid
  Role: Displays multiple Instagram posts in a compact, responsive grid.
{% endcomment %}

<div class="section-instagram-grid container mx-auto py-8 md:py-12 px-4" data-section-id="{{ section.id }}">
  {% if section.settings.title != blank %}
    <h2 class="font-stencil uppercase text-2xl mb-8 text-center text-white">{{ section.settings.title }}</h2>
  {% endif %}

  {% if section.blocks.size > 0 %}
    <div class="relative">
      <div class="instagram-grid">

        {% for block in section.blocks %}
          <div class="instagram-post-item" {{ block.shopify_attributes }}>
            {% if block.settings.video != blank %}
              <video
                src="{{ block.settings.video.sources[0].url }}"
                playsinline
                class="w-full h-full object-cover"
              ></video>
            {% endif %}
          </div>
        {% endfor %}

      </div>
      <button class="absolute top-1/2 right-0 transform -translate-y-1/2 bg-white bg-opacity-50 rounded-full p-2 text-black next-video-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </button>
    </div>
  {% else %}
    <div class="text-center">
      <p>Add Instagram posts to this section in the theme editor.</p>
    </div>
  {% endif %}
</div>

<style>
  .section-instagram-grid .relative {
    position: relative;
  }

  .section-instagram-grid .instagram-grid {
    display: flex;
    gap: 10px;
    overflow-x: auto;
    scroll-behavior: smooth;
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
    padding-bottom: 1rem;
    height: 70vh; /* Set a fixed height for vertical videos */
  }

  .section-instagram-grid .instagram-post-item {
    flex: 0 0 auto; /* Let the width be determined by video's aspect ratio */
    scroll-snap-align: start;
    position: relative;
    height: 100%;
  }

  .section-instagram-grid .instagram-post-item video {
    height: 100%;
    width: auto;
    object-fit: cover;
  }

  .next-video-btn {
    right: 1rem;
    z-index: 10;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const section = document.querySelector('[data-section-id="{{ section.id }}"]');
    if (!section) return;

    const grid = section.querySelector('.instagram-grid');
    const postItems = section.querySelectorAll('.instagram-post-item');
    const videos = section.querySelectorAll('video');
    const nextButton = section.querySelector('.next-video-btn');

    if (postItems.length === 0) return;

    let currentIndex = 0;

    // --- Video playback on intersection ---
    const videoObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        const video = entry.target;
        if (entry.isIntersecting) {
          video.muted = true;
          video.play().catch(e => console.error('Video play failed:', e));
        } else {
          video.pause();
        }
      });
    }, { threshold: 0.5 });

    videos.forEach(video => {
      videoObserver.observe(video);
    });

    // --- Sync currentIndex on scroll ---
    const postObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const intersectingItem = entry.target;
                currentIndex = Array.from(postItems).indexOf(intersectingItem);
            }
        });
    }, { root: grid, threshold: 0.5 });

    postItems.forEach(item => {
        postObserver.observe(item);
    });

    // --- Next button functionality ---
    if (nextButton) {
      nextButton.addEventListener('click', () => {
        const nextIndex = (currentIndex + 1) % postItems.length;
        const nextPostItem = postItems[nextIndex];
        if (nextPostItem) {
          grid.scrollTo({
            left: nextPostItem.offsetLeft,
            behavior: 'smooth'
          });
        }
      });
    }
  });
</script>

{% schema %}
{
  "name": "Small Instagram Grid",
  "tag": "section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Heading",
      "default": "Latest from Swear Media",
      "info": "Heading above the grid."
    }
  ],
  "blocks": [
    {
      "type": "instagram_post",
      "name": "Instagram Post",
      "settings": [
        {
          "type": "video",
          "id": "video",
          "label": "Video"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Small Instagram Grid",
      "category": "Social",
      "blocks": [
        { "type": "instagram_post" },
        { "type": "instagram_post" },
        { "type": "instagram_post" },
        { "type": "instagram_post" }
      ]
    }
  ],
  "max_blocks": 12
}
{% endschema %}